<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Working Test - Visual Web Builder</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        .test-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-header h1 {
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .test-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 10px 0;
        }
        .test-results {
            flex: 1;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
            max-height: 60vh;
            overflow-y: auto;
        }
        .test-result {
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 8px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .success { 
            background: rgba(39, 174, 96, 0.8); 
            border-left: 4px solid #27ae60;
        }
        .error { 
            background: rgba(231, 76, 60, 0.8); 
            border-left: 4px solid #e74c3c;
        }
        .info { 
            background: rgba(52, 152, 219, 0.8); 
            border-left: 4px solid #3498db;
        }
        .warning { 
            background: rgba(243, 156, 18, 0.8); 
            border-left: 4px solid #f39c12;
        }
        .test-actions {
            text-align: center;
            margin-top: 30px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 16px;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        .btn-success { 
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        .btn-secondary { 
            background: linear-gradient(45deg, #95a5a6, #bdc3c7);
            color: white;
        }
        .progress-bar {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
            margin: 20px 0;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #2ecc71);
            width: 0%;
            transition: width 0.3s ease;
        }
        .icon {
            font-size: 18px;
            min-width: 20px;
        }
    </style>
</head>
<body>
    <!-- Test Overlay -->
    <div class="test-overlay" id="test-overlay">
        <div class="test-header">
            <h1>üéØ Visual Web Builder</h1>
            <p>Final Integration Test - All Components Fixed</p>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
        
        <div class="test-results" id="test-results"></div>
        
        <div class="test-actions">
            <button class="btn btn-success" onclick="launchApplication()" style="display: none;" id="launch-btn">
                üöÄ Launch Visual Web Builder
            </button>
            <button class="btn btn-secondary" onclick="location.reload()" id="retry-btn">
                üîÑ Run Tests Again
            </button>
        </div>
    </div>

    <!-- Main App Structure (hidden during tests) -->
    <div class="app-container" style="display: none;" id="main-app">
        <header class="app-header">
            <h1>Visual Web Builder</h1>
            <div class="header-controls" role="toolbar" aria-label="Main actions">
                <button id="save-btn" class="btn btn-primary" aria-label="Save project (Ctrl+S)">Save</button>
                <button id="load-btn" class="btn btn-secondary" aria-label="Load project (Ctrl+O)">Load</button>
                <button id="export-btn" class="btn btn-secondary" aria-label="Export HTML/CSS (Ctrl+E)">Export</button>
                <button id="preview-window-btn" class="btn btn-secondary" aria-label="Open preview in new window (Ctrl+Shift+P)">Preview Window</button>
                <button id="demo-btn" class="btn btn-accent" aria-label="Toggle demo mode (F5)">Demo</button>
            </div>
        </header>

        <main class="main-content">
            <aside class="left-panel" id="element-library">
                <h2>Elements</h2>
                <div class="element-categories">
                    <div class="category">
                        <h3>Layout</h3>
                        <div class="element-list" id="layout-elements"></div>
                    </div>
                    <div class="category">
                        <h3>Text</h3>
                        <div class="element-list" id="text-elements"></div>
                    </div>
                    <div class="category">
                        <h3>Form</h3>
                        <div class="element-list" id="form-elements"></div>
                    </div>
                    <div class="category">
                        <h3>Media</h3>
                        <div class="element-list" id="media-elements"></div>
                    </div>
                </div>
            </aside>

            <section class="center-panel">
                <div class="canvas-toolbar">
                    <div class="viewport-controls" role="radiogroup" aria-label="Viewport size selection">
                        <button class="viewport-btn active" data-viewport="desktop" role="radio" aria-checked="true" aria-label="Desktop viewport (Ctrl+1)">Desktop</button>
                        <button class="viewport-btn" data-viewport="tablet" role="radio" aria-checked="false" aria-label="Tablet viewport (Ctrl+2)">Tablet</button>
                        <button class="viewport-btn" data-viewport="mobile" role="radio" aria-checked="false" aria-label="Mobile viewport (Ctrl+3)">Mobile</button>
                    </div>
                </div>
                <div class="canvas-container">
                    <div class="canvas" id="main-canvas"></div>
                </div>
            </section>

            <aside class="right-panel" id="property-editor">
                <h2>Properties</h2>
                <div class="property-sections">
                    <div class="no-selection-message">
                        <p>Select an element to edit its properties</p>
                    </div>
                    <div class="property-content" style="display: none;"></div>
                </div>
            </aside>
        </main>
    </div>

    <!-- JavaScript files -->
    <script src="js/utils/EventBus.js"></script>
    <script src="js/utils/DOMUtils.js"></script>
    <script src="js/core/ErrorHandler.js"></script>
    <script src="js/core/FallbackManager.js"></script>
    <script src="js/core/PanelManager.js"></script>
    <script src="js/core/ElementLibrary.js"></script>
    <script src="js/core/DragDropEngine.js"></script>
    <script src="js/core/CanvasManager.js"></script>
    <script src="js/core/PropertyEditor.js"></script>
    <script src="js/core/PreviewManager.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/core/ExportEngine.js"></script>
    <script src="js/core/ResponsiveManager.js"></script>
    <script src="js/core/AdvancedManipulation.js"></script>
    <script src="js/core/UXEnhancement-simple.js"></script>
    <script src="js/core/VisualWebBuilder.js"></script>

    <script>
        let testsPassed = false;
        let currentTest = 0;
        let totalTests = 0;

        function updateProgress() {
            const progress = (currentTest / totalTests) * 100;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function addTestResult(message, type, icon = '') {
            const results = document.getElementById('test-results');
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'icon';
            iconSpan.textContent = icon;
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            
            div.appendChild(iconSpan);
            div.appendChild(messageSpan);
            results.appendChild(div);
            
            // Auto-scroll to bottom
            results.scrollTop = results.scrollHeight;
            
            currentTest++;
            updateProgress();
        }

        function launchApplication() {
            document.getElementById('test-overlay').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            // Show a welcome notification
            if (window.visualWebBuilder && window.visualWebBuilder.showNotification) {
                setTimeout(() => {
                    window.visualWebBuilder.showNotification(
                        'üéâ Welcome to Visual Web Builder! All systems operational.', 
                        'success', 
                        4000
                    );
                }, 500);
            }
        }

        async function runFinalTest() {
            // Calculate total tests
            totalTests = 20; // Approximate number of tests
            
            addTestResult('Starting comprehensive final test suite...', 'info', 'üöÄ');
            
            await new Promise(resolve => setTimeout(resolve, 500));

            // Test 1: Check all critical dependencies
            addTestResult('Checking JavaScript dependencies...', 'info', 'üì¶');
            
            const criticalDependencies = [
                'EventBus', 'DOMUtils', 'ErrorHandler', 'PropertyEditor', 'AdvancedManipulation', 'VisualWebBuilder'
            ];

            let criticalOk = true;
            for (const dep of criticalDependencies) {
                await new Promise(resolve => setTimeout(resolve, 100));
                if (typeof window[dep] === 'undefined') {
                    addTestResult(`${dep} not found`, 'error', '‚ùå');
                    criticalOk = false;
                } else {
                    addTestResult(`${dep} loaded successfully`, 'success', '‚úÖ');
                }
            }

            if (!criticalOk) {
                addTestResult('Critical dependencies missing - test failed', 'error', 'üí•');
                return;
            }

            // Test 2: Check all other dependencies
            addTestResult('Checking additional components...', 'info', 'üîß');
            
            const additionalDependencies = [
                'FallbackManager', 'PanelManager', 'ElementLibrary', 'DragDropEngine', 
                'CanvasManager', 'PreviewManager', 'StorageManager', 'ExportEngine',
                'ResponsiveManager', 'UXEnhancement'
            ];

            for (const dep of additionalDependencies) {
                await new Promise(resolve => setTimeout(resolve, 50));
                if (typeof window[dep] === 'undefined') {
                    addTestResult(`${dep} not found`, 'warning', '‚ö†Ô∏è');
                } else {
                    addTestResult(`${dep} loaded`, 'success', '‚úÖ');
                }
            }

            // Test 3: DOM Structure validation
            addTestResult('Validating DOM structure...', 'info', 'üèóÔ∏è');
            
            const requiredElements = [
                '.app-container', '.app-header', '.left-panel', '.center-panel', 
                '.right-panel', '#main-canvas', '#property-editor'
            ];

            let domOk = true;
            for (const selector of requiredElements) {
                await new Promise(resolve => setTimeout(resolve, 50));
                if (!document.querySelector(selector)) {
                    addTestResult(`Missing DOM element: ${selector}`, 'error', '‚ùå');
                    domOk = false;
                } else {
                    addTestResult(`Found: ${selector}`, 'success', '‚úÖ');
                }
            }

            if (!domOk) {
                addTestResult('DOM structure validation failed', 'error', 'üí•');
                return;
            }

            // Test 4: Component instantiation
            addTestResult('Testing component instantiation...', 'info', 'üß™');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // Test PropertyEditor
                const eventBus = new EventBus();
                const rightPanel = document.getElementById('property-editor');
                const propertyEditor = new PropertyEditor(rightPanel, eventBus);
                addTestResult('PropertyEditor instantiated', 'success', '‚úÖ');

                // Test AdvancedManipulation
                const mockCanvasManager = {
                    canvas: document.getElementById('main-canvas'),
                    state: { selectedElement: null, elements: {}, rootElements: [] },
                    selectElement: function() {},
                    deselectElement: function() {},
                    processNewElement: function() {}
                };
                const advancedManipulation = new AdvancedManipulation(mockCanvasManager, eventBus);
                addTestResult('AdvancedManipulation instantiated', 'success', '‚úÖ');

            } catch (error) {
                addTestResult(`Component instantiation failed: ${error.message}`, 'error', '‚ùå');
                return;
            }

            // Test 5: Full application initialization
            addTestResult('Initializing Visual Web Builder...', 'info', '‚ö°');
            
            try {
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const app = new VisualWebBuilder();
                addTestResult('VisualWebBuilder instance created', 'success', '‚úÖ');

                await new Promise(resolve => setTimeout(resolve, 200));
                
                app.init();
                addTestResult('VisualWebBuilder initialized successfully', 'success', '‚úÖ');

                // Make globally available
                window.visualWebBuilder = app;

                // Test application state
                const state = app.getState();
                if (state && state.initialized) {
                    addTestResult('Application state is valid', 'success', '‚úÖ');
                } else {
                    addTestResult('Application state validation failed', 'warning', '‚ö†Ô∏è');
                }

                // Test event system
                let eventReceived = false;
                app.getEventBus().on('test-event', () => { eventReceived = true; });
                app.getEventBus().emit('test-event');
                
                if (eventReceived) {
                    addTestResult('Event system functioning', 'success', '‚úÖ');
                } else {
                    addTestResult('Event system issue detected', 'warning', '‚ö†Ô∏è');
                }

                // Test component integration
                if (app.propertyEditor && app.propertyEditor.initialized) {
                    addTestResult('PropertyEditor integrated successfully', 'success', '‚úÖ');
                } else {
                    addTestResult('PropertyEditor integration issue', 'warning', '‚ö†Ô∏è');
                }

                if (app.advancedManipulation && app.advancedManipulation.initialized) {
                    addTestResult('AdvancedManipulation integrated successfully', 'success', '‚úÖ');
                } else {
                    addTestResult('AdvancedManipulation integration issue', 'warning', '‚ö†Ô∏è');
                }

                // Final success
                await new Promise(resolve => setTimeout(resolve, 500));
                addTestResult('All tests completed successfully!', 'success', 'üéâ');
                addTestResult('Visual Web Builder is ready for use', 'success', 'üöÄ');
                
                // Show launch button
                document.getElementById('launch-btn').style.display = 'inline-block';
                testsPassed = true;

            } catch (error) {
                addTestResult(`Application initialization failed: ${error.message}`, 'error', '‚ùå');
                console.error('Full error:', error);
                console.error('Stack:', error.stack);
            }

            // Complete progress
            currentTest = totalTests;
            updateProgress();
        }

        // Run tests when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(runFinalTest, 1000); // Delay to ensure all scripts are loaded
        });
    </script>
</body>
</html>