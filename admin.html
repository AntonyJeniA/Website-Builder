<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMS Dashboard</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        body {
            font-family: system-ui, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 220px;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            padding-top: 1rem;
        }
        .sidebar-header {
            padding: 0 1.5rem 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            border-bottom: 1px solid #34495e;
        }
        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
            flex-grow: 1;
        }
        .sidebar-nav li a {
            display: block;
            color: #ecf0f1;
            text-decoration: none;
            padding: 0.75rem 1.5rem;
            transition: background-color 0.2s;
        }
        .sidebar-nav li a:hover, .sidebar-nav li.active a {
            background-color: #34495e;
        }
        .sidebar-footer {
            padding: 1.5rem;
            border-top: 1px solid #34495e;
        }
        .sidebar-footer a {
            color: #ecf0f1;
            text-decoration: none;
            display: block;
            text-align: center;
            background-color: #3498db;
            padding: 0.75rem;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        .sidebar-footer a:hover {
            background-color: #2980b9;
        }

        .main-content {
            flex-grow: 1;
            padding: 2rem;
            overflow-y: auto;
        }
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        .page-list {
            list-style: none;
            padding: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .page-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #eee;
        }
        .page-item:last-child {
            border-bottom: none;
        }
        .page-item-actions .btn {
            margin-left: 0.5rem;
        }
        .no-pages {
            text-align: center;
            padding: 2rem;
            color: #777;
        }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">
            My CMS
        </div>
        <ul class="sidebar-nav">
            <li class="active"><a href="#">Pages</a></li>
            <!-- Add other links here in the future, e.g., Media, Settings -->
        </ul>
        <div class="sidebar-footer">
            <a href="view.html" target="_blank">Visit Site</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="page-header">
            <h1>Pages</h1>
            <button id="create-new-page-btn" class="btn btn-primary">Create New Page</button>
        </header>
        <div id="page-list-container">
            <!-- Page list will be dynamically populated here -->
        </div>
    </main>

    <!-- Core App scripts needed for CMS -->
    <script src="js/utils/EventBus.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/core/CmsManager.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize managers
            const eventBus = new EventBus();
            const storageManager = new StorageManager(null, eventBus); // CanvasManager is not needed here
            const cmsManager = new CmsManager(storageManager);
            cmsManager.init();

            const pageListContainer = document.getElementById('page-list-container');
            const createPageBtn = document.getElementById('create-new-page-btn');

            // Function to render the list of pages
            function renderPageList() {
                const pages = cmsManager.getPages();
                pageListContainer.innerHTML = ''; // Clear current list

                if (pages.length === 0) {
                    pageListContainer.innerHTML = `
                        <div class="no-pages">
                            <p>No pages found. Create your first page to get started!</p>
                        </div>`;
                    return;
                }

                const ul = document.createElement('ul');
                ul.className = 'page-list';
                pages.forEach(page => {
                    const li = document.createElement('li');
                    li.className = 'page-item';
                    li.dataset.pageId = page.id;

                    li.innerHTML = `
                        <div class="page-item-info">
                            <strong>${escapeHTML(page.name)}</strong>
                            <br>
                            <small>id: ${escapeHTML(page.id)} | Last updated: ${new Date(page.updatedAt).toLocaleString()}</small>
                        </div>
                        <div class="page-item-actions">
                            <button class="btn btn-secondary edit-btn">Edit</button>
                            <button class="btn btn-danger delete-btn">Delete</button>
                        </div>
                    `;
                    ul.appendChild(li);
                });
                pageListContainer.appendChild(ul);
            }

            // Event handler for creating a new page
            createPageBtn.addEventListener('click', function() {
                const pageName = prompt("Enter a name for your new page (e.g., 'Home', 'About Us'):");
                if (pageName && pageName.trim() !== '') {
                    try {
                        const newPage = cmsManager.createPage(pageName.trim());
                        alert(`Page "${newPage.name}" created successfully!`);
                        renderPageList();
                    } catch (error) {
                        alert(error.message);
                    }
                }
            });

            // Event delegation for edit and delete buttons
            pageListContainer.addEventListener('click', function(event) {
                const target = event.target;
                const pageItem = target.closest('.page-item');
                if (!pageItem) return;

                const pageId = pageItem.dataset.pageId;

                // Handle Edit
                if (target.classList.contains('edit-btn')) {
                    window.location.href = `index.html?page=${pageId}`;
                }

                // Handle Delete
                if (target.classList.contains('delete-btn')) {
                    const page = cmsManager.getPage(pageId);
                    if (confirm(`Are you sure you want to delete the page "${page.name}"? This action cannot be undone.`)) {
                        cmsManager.deletePage(pageId);
                        renderPageList();
                    }
                }
            });

            // Initial render
            renderPageList();

            // Helper to prevent XSS
            function escapeHTML(str) {
                return String(str).replace(/[&<>'"]/g,
                    tag => ({
                        '&': '&amp;',
                        '<': '&lt;',
                        '>': '&gt;',
                        "'": '&#39;',
                        '"': '&quot;'
                    }[tag] || tag)
                );
            }
        });
    </script>
</body>
</html>
